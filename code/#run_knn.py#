import sys
from set_up import Setup
import json
import numpy as np
import tqdm
from scipy import sparse
from joblib import Parallel, delayed
from sklearn.metrics import average_precision_score


def fast_dice(X, Y=None):
    """Calculates Dice distance between a bunch of molecules,
    utilising sparse calculations for super fast results.
    Warning - results are dense matrices, beware of memory!
    If only X is given, this returns a dense pairwise distance
    matrix (like squareform(pdist(X)). If X and Y are given, 
    this returns a X.shape[0] by Y.shape[0] matrix, like
    cdist(X, Y, metric='dice')"""
    
    if X.dtype == np.bool:
        X = X.astype(int)
    if isinstance(X, np.ndarray):
        X = sparse.csr_matrix(X).astype(bool).astype(int)
    if Y is None:
        Y = X
    else:
        if isinstance(Y, np.ndarray):
            Y = sparse.csr_matrix(Y).astype(bool).astype(int)
            
    if Y.dtype == np.bool:
        Y = Y.astype(int)
            
    intersect = X.dot(Y.T)
    #cardinality = X.sum(1).A
    cardinality_X = X.getnnz(1)[:,None] #slightly faster on large matrices - 13s vs 16s for 12k x 12k
    cardinality_Y = Y.getnnz(1) #slightly faster on large matrices - 13s vs 16s for 12k x 12k
    return (1-(2*intersect) / (cardinality_X+cardinality_Y.T)).A


def do_similarity(idx,fp):
    """This is a pickleable function to be used by joblib.
    It just does the fast_dice calculation, then uses argpartition
    to calculate the 1200 nearest neighbors. Int32 to save a bit on
    memory. THen it vstacks it into a single array."""
    neighbors=list()
    split_idx = np.array_split(idx, 100)
    for sidx in tqdm.tqdm(split_idx):
ata:image/png;base64,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        neighbs = np.argpartition(fast_dice(fp[sidx], fp[setup.train_idx]), np.arange(0, 1200), axis=1)[:,:1200].astype(np.int32)
        neighbors.append(neighbs)
    return np.vstack(neighbors)


N_JOBS=8


if __name__=="__main__":
    fpType='morgan'
    dataset = '../processed_data/AmpC'
    setup = Setup(fpType, dataset)
    setup.load_fingerprints()
    setup.load_scores()
    setup.random_split(15000)
    true = setup.scores[setup.test_idx]<-60
    
    #for fpSize in 256, 512, 1024, 2048, 4096, 8192:
    for fpSize in 16384, 32768, 65536:
        fp = setup.fold_to_size(fpSize)

        #parallelize kNN calculation
        split_fps = Parallel(n_jobs=N_JOBS)(delayed(do_similarity)(i, fp) for i in np.array_split(setup.test_idx, N_JOBS))

        #put kNN indices back together
        concat_fps = np.vstack(split_fps)

        #calculate predictions in terms of True or False
        preds = setup.scores[setup.train_idx][concat_fps]<-60

        aps = list()
        for ncols in tqdm.tqdm(range(1,1201)):
            ap = average_precision_score(true, preds[:,:ncols].mean(axis=1))
            aps.append(ap)

        np.save('../processed_data/knn_'+str(fpSize)+'.npy', aps)
